/**
 * @file server.ts
 * @description Servidor principal de la API REST de Ecommunitas - Punto de entrada del backend
 * 
 * Este archivo constituye el n√∫cleo central del servidor backend de la aplicaci√≥n Ecommunitas.
 * Configura y inicializa un servidor Express completo que act√∫a como la API REST principal
 * para toda la aplicaci√≥n. El servidor maneja todas las operaciones del backend incluyendo
 * autenticaci√≥n, gesti√≥n de usuarios, publicaci√≥n de art√≠culos, sistema de mensajer√≠a,
 * administraci√≥n y todas las funcionalidades core de la plataforma.
 * 
 * ARQUITECTURA Y RESPONSABILIDADES:
 * ================================
 * 
 * üèóÔ∏è CONFIGURACI√ìN DEL SERVIDOR:
 * - Inicializaci√≥n de Express con TypeScript para type safety
 * - Configuraci√≥n de puerto din√°mico (desarrollo: 5000, producci√≥n: variable)
 * - Manejo de variables de entorno con validaci√≥n
 * - Configuraci√≥n de middleware en orden espec√≠fico para optimizaci√≥n
 * 
 * üîí SEGURIDAD Y PROTECCI√ìN:
 * - CORS (Cross-Origin Resource Sharing) configurado para frontend espec√≠fico
 * - Rate Limiting para prevenir ataques de fuerza bruta y spam
 * - Content Security Policy (CSP) para prevenir ataques XSS
 * - Helmet para headers de seguridad adicionales
 * - Validaci√≥n y sanitizaci√≥n de datos de entrada
 * 
 * üìÅ GESTI√ìN DE ARCHIVOS:
 * - Integraci√≥n con Cloudinary para almacenamiento en la nube
 * - Middleware de subida de archivos con validaci√≥n de tipos
 * - Compresi√≥n autom√°tica de im√°genes
 * - L√≠mites de tama√±o de archivo configurables
 * 
 * üóÑÔ∏è BASE DE DATOS:
 * - Conexi√≥n a MongoDB con Mongoose ODM
 * - Pool de conexiones optimizado
 * - √çndices de base de datos para rendimiento
 * - Manejo de reconexi√≥n autom√°tica
 * 
 * üìù SISTEMA DE LOGGING:
 * - Winston para logging estructurado y niveles
 * - Morgan para logging de requests HTTP
 * - Rotaci√≥n de logs autom√°tica
 * - Diferentes niveles: error, warn, info, debug
 * 
 * üõ°Ô∏è AUTENTICACI√ìN Y AUTORIZACI√ìN:
 * - JWT (JSON Web Tokens) para autenticaci√≥n stateless
 * - Middleware de protecci√≥n de rutas
 * - Roles y permisos granulares
 * - Refresh tokens para seguridad mejorada
 * 
 * üîÑ MANEJO DE ERRORES:
 * - Sistema centralizado de manejo de errores
 * - Respuestas de error consistentes
 * - Logging autom√°tico de errores
 * - Diferentes tipos de error seg√∫n contexto
 * 
 * üìä FUNCIONALIDADES AVANZADAS:
 * - Middleware de paginaci√≥n para grandes datasets
 * - Filtrado y ordenamiento din√°mico
 * - B√∫squeda full-text en m√∫ltiples campos
 * - Cach√© de respuestas para optimizaci√≥n
 * 
 * üåê RUTAS Y ENDPOINTS:
 * - /api/auth - Autenticaci√≥n y registro de usuarios
 * - /api/users - Gesti√≥n de perfiles de usuario
 * - /api/items - CRUD de art√≠culos y publicaciones
 * - /api/messages - Sistema de mensajer√≠a privada
 * - /api/admin - Panel de administraci√≥n
 * 
 * FLUJO DE INICIALIZACI√ìN:
 * =======================
 * 1. Carga de variables de entorno (.env)
 * 2. Configuraci√≥n de logging y colores
 * 3. Conexi√≥n a base de datos MongoDB
 * 4. Inicializaci√≥n de Express app
 * 5. Configuraci√≥n de middleware de seguridad
 * 6. Configuraci√≥n de parsers y CORS
 * 7. Registro de rutas de la API
 * 8. Middleware de manejo de errores
 * 9. Inicio del servidor en puerto especificado
 * 10. Configuraci√≥n de handlers para se√±ales del sistema
 * 
 * VARIABLES DE ENTORNO REQUERIDAS:
 * ===============================
 * - NODE_ENV: Entorno de ejecuci√≥n (development/production)
 * - PORT: Puerto del servidor (default: 5000)
 * - MONGO_URI: URI de conexi√≥n a MongoDB
 * - JWT_SECRET: Clave secreta para JWT
 * - CLOUDINARY_CLOUD_NAME: Nombre de cloud de Cloudinary
 * - CLOUDINARY_API_KEY: API key de Cloudinary
 * - CLOUDINARY_API_SECRET: API secret de Cloudinary
 * 
 * DEPENDENCIAS PRINCIPALES:
 * =======================
 * - express: Framework web minimalista y flexible
 * - mongoose: ODM para MongoDB con validaci√≥n de esquemas
 * - jsonwebtoken: Implementaci√≥n de JWT para Node.js
 * - bcryptjs: Hashing de contrase√±as con salt
 * - cloudinary: SDK para gesti√≥n de archivos multimedia
 * - winston: Logger avanzado con m√∫ltiples transportes
 * - cors: Middleware para Cross-Origin Resource Sharing
 * - helmet: Colecci√≥n de middleware de seguridad
 * - express-rate-limit: Rate limiting para prevenir abuso
 * 
 * @author Equipo de Desarrollo Ecommunitas
 * @version 1.0.0
 * @since 1.0.0
 * @created 2024
 * @lastModified 2024
 * 
 * @example
 * // Iniciar el servidor en desarrollo:
 * npm run dev
 * 
 * @example
 * // Iniciar el servidor en producci√≥n:
 * npm start
 * 
 * @see {@link https://expressjs.com/} Express.js Documentation
 * @see {@link https://mongoosejs.com/} Mongoose Documentation
 * @see {@link https://jwt.io/} JWT Documentation
 */

// ============================================================================
// CONFIGURACI√ìN CR√çTICA DE VARIABLES DE ENTORNO
// ============================================================================
/**
 * IMPORTANTE: Las variables de entorno DEBEN cargarse ANTES que cualquier otro m√≥dulo
 * para garantizar que est√©n disponibles durante todo el proceso de inicializaci√≥n.
 * 
 * El archivo .env debe estar ubicado en la ra√≠z del directorio backend y contener
 * todas las variables necesarias para el funcionamiento de la aplicaci√≥n.
 * 
 * Si las variables no se cargan correctamente, la aplicaci√≥n fallar√° durante
 * la inicializaci√≥n con errores de configuraci√≥n.
 */
import dotenv from 'dotenv';
import path from 'path';

// Cargar variables de entorno desde el archivo .env con path absoluto
// Esto asegura que funcione independientemente del directorio de trabajo actual
dotenv.config({ path: path.join(__dirname, '../.env') });

// ============================================================================
// IMPORTACIONES DE M√ìDULOS PRINCIPALES DEL ECOSISTEMA NODE.JS
// ============================================================================
/**
 * Importaci√≥n de dependencias externas despu√©s de cargar variables de entorno.
 * El orden de importaci√≥n es importante para evitar problemas de inicializaci√≥n.
 */

// Framework web principal - Express.js
// Proporciona la infraestructura b√°sica para crear el servidor HTTP
import express from 'express';

// Logger HTTP para desarrollo - Morgan
// Registra todas las peticiones HTTP con detalles de timing y status
import morgan from 'morgan';

// Utilidad para colores en terminal - Colors
// Mejora la legibilidad de logs en desarrollo con colores
import colors from 'colors';

// Cross-Origin Resource Sharing - CORS
// Permite que el frontend acceda a la API desde diferentes dominios
import cors from 'cors';

// Rate Limiting para prevenci√≥n de abuso - Express Rate Limit
// Limita el n√∫mero de requests por IP en un per√≠odo de tiempo
import rateLimit from 'express-rate-limit';

// Sistema de logging avanzado - Winston
// Proporciona logging estructurado con m√∫ltiples niveles y transportes
import { createLogger, transports, format } from 'winston';

// Generador de identificadores √∫nicos - UUID v4
// Utilizado para generar IDs √∫nicos para requests y sesiones
import { v4 as uuidv4 } from 'uuid';

// Middleware para manejo de archivos - Express File Upload
// @ts-ignore - Esta librer√≠a no tiene tipos TypeScript oficiales
// Permite la subida de archivos multipart/form-data
import fileUpload from 'express-fileupload';

// ============================================================================
// IMPORTACIONES DE M√ìDULOS LOCALES DE LA APLICACI√ìN
// ============================================================================
/**
 * Importaci√≥n de m√≥dulos desarrollados espec√≠ficamente para Ecommunitas.
 * Estos m√≥dulos contienen la l√≥gica de negocio y configuraci√≥n espec√≠fica.
 */

// Middleware personalizado para manejo de archivos
// Configura la subida de archivos con validaciones espec√≠ficas y integraci√≥n con Cloudinary
import fileUploadMiddleware from './middleware/fileUpload';

// Configuraci√≥n y conexi√≥n a la base de datos MongoDB
// Maneja la conexi√≥n, reconexi√≥n autom√°tica y configuraci√≥n de √≠ndices
import connectDB from './config/db';

// Middleware centralizado de manejo de errores
// Procesa todos los errores de la aplicaci√≥n y devuelve respuestas consistentes
import errorMiddleware from './middleware/error';

// ============================================================================
// IMPORTACI√ìN DE RUTAS DE LA API REST
// ============================================================================
/**
 * Importaci√≥n de todos los m√≥dulos de rutas que definen los endpoints de la API.
 * Cada m√≥dulo maneja un dominio espec√≠fico de la aplicaci√≥n:
 */

// Rutas de autenticaci√≥n y autorizaci√≥n (/api/auth)
// Maneja registro, login, logout, recuperaci√≥n de contrase√±a, verificaci√≥n de email
import authRoutes from './routes/auth';

// Rutas de gesti√≥n de art√≠culos y publicaciones (/api/items)
// CRUD completo de art√≠culos, b√∫squeda, filtrado, categorizaci√≥n
import itemsRoutes from './routes/items';

// Rutas del sistema de mensajer√≠a privada (/api/messages)
// Env√≠o, recepci√≥n, marcado como le√≠do, conversaciones, notificaciones
import messagesRoutes from './routes/messages';

// Rutas de gesti√≥n de usuarios (/api/users)
// Perfiles, configuraci√≥n, seguimiento, bloqueo, administraci√≥n de cuentas
import usersRoutes from './routes/users';

// ============================================================================
// INICIALIZACI√ìN CR√çTICA DE BASE DE DATOS
// ============================================================================
/**
 * IMPORTANTE: La conexi√≥n a la base de datos debe establecerse ANTES de
 * inicializar el servidor Express para asegurar que todos los modelos
 * est√©n disponibles cuando se procesen las primeras requests.
 * 
 * La funci√≥n connectDB() maneja:
 * - Conexi√≥n inicial a MongoDB
 * - Configuraci√≥n de opciones de conexi√≥n
 * - Manejo de errores de conexi√≥n
 * - Reconexi√≥n autom√°tica en caso de p√©rdida de conexi√≥n
 * - Creaci√≥n de √≠ndices de base de datos para optimizaci√≥n
 */
if (process.env.NODE_ENV !== 'test') {
  connectDB();
}

// ============================================================================
// CONFIGURACI√ìN DE LA APLICACI√ìN EXPRESS
// ============================================================================
/**
 * Crear la instancia principal de Express que actuar√° como servidor HTTP.
 * Esta instancia ser√° configurada con todos los middleware necesarios
 * y las rutas de la API antes de ser iniciada.
 */
const app = express();

// ============================================================================
// CONFIGURACI√ìN DE MIDDLEWARE B√ÅSICO Y PARSERS
// ============================================================================
/**
 * Los middleware se ejecutan en orden secuencial para cada request.
 * El orden de configuraci√≥n es cr√≠tico para el funcionamiento correcto.
 */

/**
 * PARSER DE JSON:
 * Middleware integrado de Express para parsear autom√°ticamente el contenido JSON
 * del body de las requests HTTP. Esto permite acceder a req.body como objeto JavaScript.
 * 
 * Configuraci√≥n:
 * - L√≠mite de tama√±o: 10mb (configurable)
 * - Tipos MIME aceptados: application/json
 * - Validaci√≥n autom√°tica de sintaxis JSON
 * 
 * Sin este middleware, req.body ser√≠a undefined para requests con contenido JSON.
 */
app.use(express.json());

/**
 * CONFIGURACI√ìN CORS (Cross-Origin Resource Sharing):
 * Middleware esencial para permitir que el frontend (Vue.js) se comunique
 * con la API desde un dominio/puerto diferente.
 * 
 * Configuraci√≥n actual: Permisiva (permite todos los or√≠genes)
 * Configuraci√≥n recomendada para producci√≥n:
 * {
 *   origin: ['https://ecommunitas.com', 'https://www.ecommunitas.com'],
 *   credentials: true,
 *   methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
 *   allowedHeaders: ['Content-Type', 'Authorization']
 * }
 * 
 * Headers CORS que se a√±aden autom√°ticamente:
 * - Access-Control-Allow-Origin
 * - Access-Control-Allow-Methods
 * - Access-Control-Allow-Headers
 * - Access-Control-Allow-Credentials
 */
app.use(cors());

/**
 * Middleware de logging para desarrollo
 * Morgan registra todas las peticiones HTTP en la consola
 * Solo se activa en modo desarrollo para no saturar logs en producci√≥n
 */
if (process.env.NODE_ENV === 'development') {
  app.use(morgan('dev'));
}

/**
 * Middleware personalizado para manejo de archivos
 * Configura la carga de archivos con validaciones y l√≠mites
 * Integrado con Cloudinary para almacenamiento en la nube
 */
fileUploadMiddleware(app);

// ============================================================================
// CONFIGURACI√ìN DE SEGURIDAD Y LOGGING
// ============================================================================

/**
 * Configuraci√≥n del logger para violaciones de Content Security Policy (CSP)
 * Utiliza Winston para registrar todas las violaciones de seguridad CSP
 * en un archivo dedicado para su posterior an√°lisis
 */
const cspLogger = createLogger({
  level: 'info',                           // Nivel de logging
  format: format.combine(                  // Formato de los logs
    format.timestamp(),                    // A√±ade timestamp a cada entrada
    format.json()                          // Formato JSON para f√°cil procesamiento
  ),
  transports: [
    // Almacena los logs en un archivo dedicado
    new transports.File({ filename: 'logs/csp-violations.log' })
  ]
});

/**
 * Endpoint para reportar violaciones de Content Security Policy
 * Recibe informes autom√°ticos del navegador cuando se detectan
 * violaciones de la pol√≠tica de seguridad de contenido
 * 
 * @route POST /report-violation
 * @access Public
 */
app.post('/report-violation', express.json({ type: 'application/csp-report' }), (req, res) => {
  const requestId = uuidv4();  // Genera ID √∫nico para cada reporte
  
  // Registra la violaci√≥n en el log con todos los detalles
  cspLogger.info('CSP Violation', {
    requestId,
    ...req.body['csp-report']
  });
  
  // Responde con 204 (No Content) ya que no es necesario enviar datos al cliente
  res.status(204).end();
});

/**
 * Configuraci√≥n de Rate Limiting (limitaci√≥n de velocidad)
 * Protege contra ataques de fuerza bruta y DoS limitando
 * el n√∫mero de peticiones que un cliente puede hacer en un per√≠odo
 */
const limiter = rateLimit({
  windowMs: 10 * 60 * 1000,  // Ventana de tiempo: 10 minutos
  max: 100,                  // M√°ximo 100 peticiones por IP en la ventana de tiempo
  message: 'Demasiadas peticiones desde esta IP, por favor intente de nuevo despu√©s de 10 minutos'
});

/**
 * Aplicar limitaci√≥n de velocidad a todas las rutas de la API
 * Esto protege todos los endpoints bajo /api/* de posibles abusos
 */
app.use('/api', limiter);

// ============================================================================
// CONFIGURACI√ìN DE RUTAS DE LA API
// ============================================================================

/**
 * Montaje de rutas de la API
 * Cada grupo de rutas maneja un dominio espec√≠fico de la aplicaci√≥n:
 * - auth: Autenticaci√≥n y autorizaci√≥n de usuarios
 * - items: Gesti√≥n de art√≠culos para intercambio
 * - messages: Sistema de mensajer√≠a entre usuarios
 * - users: Gesti√≥n de perfiles y datos de usuarios
 */
app.use('/api/v1/auth', authRoutes);         // Rutas de autenticaci√≥n
app.use('/api/v1/items', itemsRoutes);       // Rutas de art√≠culos
app.use('/api/v1/messages', messagesRoutes); // Rutas de mensajer√≠a
app.use('/api/v1/users', usersRoutes);       // Rutas de usuarios

// ============================================================================
// MIDDLEWARE DE MANEJO DE ERRORES
// ============================================================================

/**
 * Middleware de manejo de errores centralizado
 * IMPORTANTE: Debe ir al final de todas las rutas y middleware
 * Captura y procesa todos los errores que ocurran en la aplicaci√≥n
 */
app.use(errorMiddleware.errorHandler);

// ============================================================================
// CONFIGURACI√ìN E INICIO DEL SERVIDOR
// ============================================================================

/**
 * Configuraci√≥n del puerto del servidor
 * Utiliza la variable de entorno PORT o el puerto 5000 por defecto
 */
const PORT = process.env.PORT || 5000;

/**
 * Inicializaci√≥n del servidor HTTP
 * Inicia el servidor Express en el puerto especificado
 */
let server: any;
if (process.env.NODE_ENV !== 'test') {
  server = app.listen(PORT, () => {
    console.log(colors.yellow.bold(`üöÄ Servidor corriendo en modo ${process.env.NODE_ENV} en puerto ${PORT}`));
  });
}

// ============================================================================
// MANEJO DE ERRORES GLOBALES Y CIERRE GRACEFUL
// ============================================================================

/**
 * Manejo de promesas rechazadas no capturadas
 * Captura errores asincr√≥nicos que no fueron manejados apropiadamente
 * y cierra el servidor de manera segura
 */
process.on('unhandledRejection', (err: any, promise) => {
  console.log(colors.red(`‚ùå Error de promesa no manejada: ${err.message}`));
  
  // Cerrar servidor de manera segura y salir del proceso
  if (server) {
    server.close(() => {
      process.exit(1);
    });
  } else {
    process.exit(1);
  }
});

export default app;